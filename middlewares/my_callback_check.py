import logging
import random
from typing import Callable, Awaitable, Dict, Any

from aiogram import BaseMiddleware
from aiogram.dispatcher.flags import get_flag
from aiogram.types import TelegramObject, CallbackQuery

from handlers.driver_callback import MyCallback

logger = logging.getLogger(__name__)

class MyCallbackCheckMiddleware(BaseMiddleware):
    def __init__(self):
        super().__init__()

    async def __call__(
            self,
            handler: Callable[[TelegramObject, Dict[str, Any]], Awaitable[Any]],
            event: TelegramObject,
            data: Dict[str, Any],
    ) -> Any:
        """
        –î–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö callback-–æ–≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —ç—Ç–æ —Ç–æ—Ç —Å–∞–º—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ –±—ã–ª–∏ –∫–Ω–æ–ø–∫–∏
        """

        if not isinstance(event, CallbackQuery):
            return await handler(event, data)

        need_check_handler = get_flag(data, "check_callback")
        if not need_check_handler:
            return await handler(event, data)

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–≤—É—é —á–∞—Å—Ç—å data –∏–∑ –∫–æ–ª–±–µ–∫–∞ –∏ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º –µ–µ —Å id –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_id = event.from_user.id
        callback_user_id = await self.get_callback_user_id(event)
        if str(user_id) != str(callback_user_id):
            text = await self.get_random_restriction_text()
            await event.answer(text=text, show_alert=True)
            logger.info(
                f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} ({event.from_user.full_name}) –ø—ã—Ç–∞–ª—Å—è –Ω–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É –Ω–µ –¥–ª—è –Ω–µ–≥–æ –∏ –ø–æ–ª—É—á–∏–ª '{text}'")
            return

        return await handler(event, data)

    async def get_callback_user_id(self, event):
        try:
            # –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ callback'–∞, –∏—Å–ø–æ–ª—å–∑—É—è DriverCallbackFactory
            callback_data = MyCallback.unpack(event.data)
            return callback_data.user_id if callback_data.user_id is not None else (event.data + "_").split("_")[1]
        except Exception:
            # –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ —è–≤–ª—è—é—Ç—Å—è DriverCallbackFactory, —Ç–æ –±–µ—Ä–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ _
            return (event.data + "_").split("_")[1]

    async def get_random_restriction_text(self):
        # –°–ø–∏—Å–æ–∫ –∏–∑ —Ä–∞–∑–Ω—ã—Ö —Ñ—Ä–∞–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π, –≥–æ–≤–æ—Ä—è—â–∏—Ö, —á—Ç–æ –Ω–µ–ª—å–∑—è –Ω–∞–∂–∏–º–∞—Ç—å —ç—Ç—É –∫–Ω–æ–ø–∫—É
        texts = [
            "–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç—É –∫–Ω–æ–ø–∫—É.",
            "–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –Ω–∞–∂–∞—Ç—å –Ω–∞ —ç—Ç—É –∫–Ω–æ–ø–∫—É.",
            "–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –Ω–∞–∂–∞—Ç—å —ç—Ç—É –∫–Ω–æ–ø–∫—É.",
            "‚ùå –≠—Ç–∞ –∫–Ω–æ–ø–∫–∞ –Ω–µ –¥–ª—è –≤–∞—Å!",
            "üçä –≠—Ç–æ –Ω–∞ –ù–æ–≤—ã–π –≥–æ–¥! üéÖ",
            "–≠—Ç—É –∫–Ω–æ–ø–∫—É –Ω–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å.",
            "‚ö° –ù–µ –≤–ª–µ–∑–∞–π ‚Äî —É–±—å–µ—Ç!",
            "üßÄ –≠—Ç–∞ –∫–Ω–æ–ø–∫–∞ ‚Äî –ª–æ–≤—É—à–∫–∞ –¥–ª—è –ª—é–±–æ–ø—ã—Ç–Ω—ã—Ö. –¢—ã —Ç–æ—á–Ω–æ –Ω–µ –ª—é–±–æ–ø—ã—Ç–Ω—ã–π?",
            "üèùÔ∏è –ö–Ω–æ–ø–∫–∞ –≤ –æ—Ç–ø—É—Å–∫–µ. –í–µ—Ä–Ω—ë—Ç—Å—è —á–µ—Ä–µ–∑ ‚àû –¥–Ω–µ–π.",
            "üç™ –ù–µ —Ç—ã–∫–∞–π! –¢–∞–º –∂–∏–≤—ë—Ç —Ç—Ä–æ–ª–ª—å, –∫–æ—Ç–æ—Ä—ã–π –µ—Å—Ç –ø–µ—á–µ–Ω—å–∫–∏.",
            "üì∫ –ó–¥–µ—Å—å –º–æ–≥–ª–∞ –±—ã—Ç—å –≤–∞—à–∞ —Ä–µ–∫–ª–∞–º–∞. –ù–æ –∫–Ω–æ–ø–∫–∞ —Å–ª–æ–º–∞–ª–∞—Å—å.",
            "–≠—Ç–∞ –∫–Ω–æ–ø–∫–∞ ‚Äî –∫–∞–∫ –ø–∞—Ä–∫–æ–≤–∫–∞ –≤ —á–∞—Å –ø–∏–∫: —Ç—Ä–æ–≥–∞—Ç—å –Ω–µ–ª—å–∑—è!",
            "üèéÔ∏è –ù–µ –Ω–∞–∂–∏–º–∞–π ‚Äî –∏–Ω–∞—á–µ —Ç–≤–æ–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å –Ω–∞—É—á–∏—Ç—Å—è –¥—Ä–∏—Ñ—Ç–æ–≤–∞—Ç—å –±–µ–∑ —Ç–µ–±—è.",
            "üö≤ –ó–¥–µ—Å—å –º–æ–≥–ª–∞ –±—ã—Ç—å —Ç–≤–æ—è –ø–∞—Ä–∫–æ–≤–∫–∞, –Ω–æ –µ—ë —É–∂–µ –∑–∞–Ω—è–ª —á–µ–π-—Ç–æ –≤–µ–ª–æ—Å–∏–ø–µ–¥.",
            "‚ö†Ô∏è –ö–Ω–æ–ø–∫–∞ –Ω–∞ —Ä—É—á–Ω–∏–∫–µ. –°–Ω–∏–º–∏—Ç–µ –µ–≥–æ, –Ω–æ –ª—É—á—à–µ –Ω–µ –Ω–∞–¥–æ.",
            "–≠—Ç–∞ –∫–Ω–æ–ø–∫–∞ ‚Äî –∫–∞–∫ –ø–∞—Ä–∫–æ–≤–æ—á–Ω–æ–µ –º–µ—Å—Ç–æ: –∫–∞–∂–µ—Ç—Å—è —Å–≤–æ–±–æ–¥–Ω–æ–π, –Ω–æ —ç—Ç–æ –Ω–µ —Ç–∞–∫.",
            "–¢—ã–∫–Ω–µ—à—å ‚Äî —Ç–≤–æ—ë –º–µ—Å—Ç–æ –∑–∞–π–º—ë—Ç —Å–∞–º–æ—É–≤–µ—Ä–µ–Ω–Ω—ã–π —Å–µ–¥–∞–Ω —Å —Ç–æ–Ω–∏—Ä–æ–≤–∫–æ–π.",
            "–û—Å—Ç–æ—Ä–æ–∂–Ω–æ: –∫–Ω–æ–ø–∫–∞ –≤—ã–∑—ã–≤–∞–µ—Ç –∂–µ–ª–∞–Ω–∏–µ –ø–∞—Ä–∫–æ–≤–∞—Ç—å—Å—è –∑–∞–¥–æ–º –∫–∞–∫ –≤ –∞–≤—Ç–æ—à–∫–æ–ª–µ.",
            "–≠—Ç–∞ –∫–Ω–æ–ø–∫–∞ ‚Äî –∫–∞–∫ –ø–∞—Ä–∫–æ–≤–æ—á–Ω—ã–π –∫–æ–Ω—É—Å. –£–≤–∞–∂–∞–π –µ—ë –ª–∏—á–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ!",
            "‚úçÔ∏è –ù–∞–∂–∞—Ç–∏–µ = –ø–æ–¥–ø–∏—Å–∞–Ω–∏–µ –¥–æ–≥–æ–≤–æ—Ä–∞ –æ –ª—é–±–≤–∏ –∫ –æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–º—É —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç—É.",
            "–ù–µ —Ç—ã–∫–∞–π! –ö–Ω–æ–ø–∫–∞ –±–æ–∏—Ç—Å—è, —á—Ç–æ –µ—ë –∑–∞–º–µ–Ω—è—Ç –Ω–∞ –∞–≤—Ç–æ–ø–∏–ª–æ—Ç.",
            "üëª –ó–¥–µ—Å—å –ø–∞—Ä–∫—É–µ—Ç—Å—è –ø—Ä–∏–∑—Ä–∞–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –≤—Å–µ–≥–¥–∞ —É—Ö–æ–¥–∏—Ç –≤–æ–≤—Ä–µ–º—è.",
            "üö¨ –ö–Ω–æ–ø–∫–∞ –Ω–∞ –ø–µ—Ä–µ–∫—É—Ä–µ.",
            "–ö–Ω–æ–ø–∫–∞ –≤–µ—Ä–Ω—ë—Ç—Å—è, –∫–æ–≥–¥–∞ –∑–∞–∫–æ–Ω—á–∏—Ç—Å—è —Å–æ–≤–µ—â–∞–Ω–∏–µ.",
            "üíÖ –ö–Ω–æ–ø–∫–∞ –Ω–∞ –º–∞–Ω–∏–∫—é—Ä–µ.",
            "–ù–µ –Ω–∞–∂–∏–º–∞–π! –ò–Ω–∞—á–µ —Ç–≤–æ–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å –ø–æ–ª—É—á–∏—Ç –ø–æ–≤—ã—à–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ —Ç–µ–±—è.",
            "–ö–Ω–æ–ø–∫–∞ –Ω–∞ —É–¥–∞–ª—ë–Ω–∫–µ. –í–µ—Ä–Ω—ë—Ç—Å—è, –∫–æ–≥–¥–∞ –∑–∞–∫–æ–Ω—á–∞—Ç—Å—è –ø—Ä–æ–±–∫–∏.",
            "üõ†Ô∏è –ö–Ω–æ–ø–∫–∞ –Ω–∞ —Ç–µ—Ö–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–∏.",
            "üõ∏ –ù–µ —Ç—Ä–æ–≥–∞–π! –≠—Ç–æ –º–µ—Å—Ç–æ –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è –ª–µ—Ç–∞—é—â–∏—Ö –∞–≤—Ç–æ –∏–∑ 2050."
        ]

        # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é —Ñ—Ä–∞–∑—É
        return random.choice(texts)
